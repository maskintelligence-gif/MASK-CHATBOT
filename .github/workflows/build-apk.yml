name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'

    - name: Check and Generate Project Structure
      run: |
        # Create minimal lib/main.dart if it doesn't exist
        if [ ! -f "lib/main.dart" ]; then
          echo "Creating lib/main.dart..."
          mkdir -p lib
          cat > lib/main.dart << 'EOF'
import 'package:flutter/material.dart';

void main() => runApp(const MyApp());

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'MASK ChatBot',
      home: Scaffold(
        appBar: AppBar(title: const Text('MASK ChatBot')),
        body: const Center(child: Text('App is building!')),
      ),
    );
  }
}
EOF
        fi

        # Create pubspec.yaml if it doesn't exist
        if [ ! -f "pubspec.yaml" ]; then
          echo "Creating pubspec.yaml..."
          cat > pubspec.yaml << 'EOF'
name: mask_chatbot
description: MASK ChatBot - AI Chat with Groq
publish_to: 'none'
version: 1.0.0+1
environment:
  sdk: '>=3.0.0 <4.0.0'
  flutter: ">=3.19.0"
dependencies:
  flutter:
    sdk: flutter
dev_dependencies:
  flutter_test:
    sdk: flutter
flutter:
  uses-material-design: true
EOF
        fi

        # Generate Android/iOS files if missing
        if [ ! -d "android" ] || [ ! -d "ios" ]; then
          echo "Generating Flutter project structure..."
          
          # Backup existing files
          mkdir -p temp_backup
          [ -d "lib" ] && cp -r lib temp_backup/ 2>/dev/null || true
          [ -f "pubspec.yaml" ] && cp pubspec.yaml temp_backup/ 2>/dev/null || true
          [ -f "README.md" ] && cp README.md temp_backup/ 2>/dev/null || true
          [ -f ".gitignore" ] && cp .gitignore temp_backup/ 2>/dev/null || true
          
          # Create proper Flutter project
          flutter create --project-name mask_chatbot --org com.mask --platforms android,ios .
          
          # Restore our files
          [ -d "temp_backup/lib" ] && rm -rf lib && cp -r temp_backup/lib . || true
          [ -f "temp_backup/pubspec.yaml" ] && cp temp_backup/pubspec.yaml . || true
          [ -f "temp_backup/README.md" ] && cp temp_backup/README.md . || true
          [ -f "temp_backup/.gitignore" ] && cp temp_backup/.gitignore . || true
          
          rm -rf temp_backup
          echo "âœ… Project structure generated!"
        else
          echo "âœ… Project structure already exists."
        fi

    - name: Install Dependencies
      run: |
        # Update pubspec.yaml with your dependencies if needed
        if ! grep -q "http:" pubspec.yaml; then
          echo "Adding dependencies to pubspec.yaml..."
          cat >> pubspec.yaml << 'EOF'

# Your dependencies
dependencies:
  flutter:
    sdk: flutter
  http: ^1.1.0
  provider: ^6.1.1
  flutter_markdown: ^0.6.15
  speech_to_text: ^6.6.0
  image_picker: ^1.0.4
  clipboard: ^0.1.3
  share_plus: ^7.2.1
  path_provider: ^2.1.0
  sqflite: ^2.3.0
  path: ^1.9.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.1
EOF
        fi
        
        flutter pub get

    - name: Build APK
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        echo "Building APK..."
        flutter build apk --release \
          --split-per-abi
        echo "âœ… APK build complete!"
        ls -la build/app/outputs/flutter-apk/

    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: apk-files
        path: build/app/outputs/flutter-apk/
        if-no-files-found: error
        retention-days: 7

    - name: Create Release Summary
      if: success()
      run: |
        echo "## ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**APK Files Generated:**" >> $GITHUB_STEP_SUMMARY
        echo "- app-release.apk (Universal)" >> $GITHUB_STEP_SUMMARY
        echo "- app-arm64-v8a-release.apk (64-bit ARM)" >> $GITHUB_STEP_SUMMARY
        echo "- app-armeabi-v7a-release.apk (32-bit ARM)" >> $GITHUB_STEP_SUMMARY
        echo "- app-x86_64-release.apk (64-bit x86)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download from the Artifacts section above. ðŸš€" >> $GITHUB_STEP_SUMMARY
